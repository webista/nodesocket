<html>
<head>
  <title>Chat with socket.io and node.js</title>
  <style>
    #chat {
      height: 500px;
      overflow-y: scroll;
    }
    #content-wrap {
      display: none;
    }
    #chat-wrap {
      float: left;
      border: 1px #000 solid;
    }
  </style>
</head>
<body>
    <h1>Update: Nakasave na sa db to so may history na hehe</h1>
  <div id="nick-wrap">
    <p>Enter a username:</p>
    <p id="nick-err"></p>
    <form id="set-nick">
      <input size="35" id="nickname">
      <input type="submit">
    </form>
  </div>

  <div id="content-wrap">
     <div id="chat-wrap">
        <div id="chat"></div>
        <form id="send-msg">
          <input size="35" id="msg">
          <input type="submit">
        </form>
	</div>
	<div id="users"></div>
  </div>

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    $(function() {
        var socket = io.connect(),
            $nickForm = $('#set-nick'),
            $nickError = $('#nick-err'),
            $nickBox = $('#nickname'),
            $users = $('#users'),
            $msgForm = $('#send-msg'),
            $msgBox = $('#msg'),
            $chat = $('#chat'),

            tagBody = '(?:[^"\'>]|"[^"]*"|\'[^\']*\')*',
            tagOrComment = new RegExp(
            '<(?:'
            // Comment body.
            + '!--(?:(?:-*[^->])*--+|-?)'
            // Special "raw text" elements whose content should be elided.
            + '|script\\b' + tagBody + '>[\\s\\S]*?</script\\s*'
            + '|style\\b' + tagBody + '>[\\s\\S]*?</style\\s*'
            // Regular name
            + '|/?[a-z]'
            + tagBody
            + ')>',
            'gi');

        function removeTags(html) {
            var oldHtml;
            do {
                oldHtml = html;
                html = html.replace(tagOrComment, '');
            } while (html !== oldHtml) {
                return html.replace(/</g, '&lt;');
            }
        }

        $nickForm.submit(function(e) {
            e.preventDefault();
         
            socket.emit('new user', $nickBox.val(), function(data) {
                if (data) {
                    $('#nick-wrap').hide();
                    $('#content-wrap').show();
                } else {
                    $nickError.html('That username is already taken, try again!');
                }
            });

            $nickBox.val('');
            var wtf    = $('#chat'),
                height = wtf[0].scrollHeight;
            
            wtf.scrollTop(height);
        });

        socket.on('usernames', function(data) {
            var html = '';
	 
            for(var key in data) {
                html += data[key] +'<br >';
            }

            $users.html(html);
        });

        $msgForm.submit(function(e) {
            e.preventDefault();

            socket.emit('send message', $msgBox.val(), function(data) {
                $chat.append('<strong style="color: red;">Error, invalid user</strong><br>');
            });
            $msgBox.val('');
        });

        socket.on('load old msgs', function(docs) {
            for(var key in docs) {
                displayMsg(docs[key]);
            }
        });

        function displayMsg(data) {
            $chat.append('<strong style="font-style: italic;">'+ data.nick +'</strong>: ' + data.msg + '<br>');
        }

        socket.on('new message', function(data) {
            $chat.append('<strong>'+ data.nick +'</strong>: ' + data.msg);
            $chat.append('<br>');
        });

        socket.on('whisper', function(data) {
            $chat.append('<strong style="font-style: italic;">'+ data.nick +'</strong>: ' + data.msg);
        });
    });
  </script>
</body>
</html>
